#!/usr/bin/env python
# -*- coding: utf-8 -*-

from __future__ import print_function
import datetime
import sys
import subprocess
import json
import mallard.utils
import re

def deploy(image, name):
    image = create(image, name)
    print(start(image['Id']))

def create(image, name):
    data = { "Image": image }
    url = "containers/create"
    if name and not re.compile("^[a-zA-Z0-9_-]+$").match(name):
        print("Error: '{}' is a invalid name.".format(name))
        sys.exit(1)
    if name: url = "{}?name={}".format(url, name)
    ret = mallard.utils.callapi_post(url, data=data)
    try:
        return json.loads(ret)
    except:
        print("Error: Faild to create image")
        print(ret)
        sys.exit(1)

def start(uuid):
    ret = mallard.utils.callapi_post("containers/{}/start".format(uuid))
    if len(ret) > 0:
        print("Error: Faild to start image {}".format(uuid))
        print(ret)
        sys.exit(1)
